<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Analisis Olahraga ‚Äî Realtime Firebase</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    /* === GAYA UMUM === */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f9ff; color: #333; line-height: 1.6; }
    header { text-align: center; padding: 20px; background: #1a73e8; color: white; position: relative; }
    #authPanel { position: absolute; top: 10px; right: 10px; font-size: 0.9em; }
    #authPanel button { margin-left: 8px; padding: 4px 10px; font-size: 0.9em; }
    nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; padding: 12px; background: #e3f2fd; border-bottom: 1px solid #ccc; }
    nav button { padding: 10px 16px; background: #ffffff; border: 1px solid #1a73e8; border-radius: 6px; cursor: pointer; font-weight: bold; color: #1a73e8; }
    nav button.active { background: #1a73e8; color: white; }
    .section { display: none; padding: 20px; max-width: 950px; margin: 20px auto; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .section.active { display: block; }
    h2 { margin-bottom: 15px; color: #1a73e8; }
    /* === LOGIN FORM === */
    #loginForm { display: none; padding: 20px; text-align: center; background: #fff; border-radius: 10px; max-width: 400px; margin: 20px auto; }
    #loginForm input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; }
    #loginForm button { padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; }
    /* === GAYA PARLAY === */
    #parlay .match, #parlay .fair-odds-table, #parlay .parlay-input {
      background: white; padding: 15px; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    #parlay .parlay-input { text-align: center; background: #fff8e1; }
    #parlay .parlay-result { background: #e8f0fe; padding: 20px; margin-top: 20px; border-radius: 10px; text-align: center; font-weight: bold; }
    #parlay input { width: 80px; padding: 6px; margin: 0 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; }
    #parlay button { display: block; margin: 15px auto; padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 6px; font-size: 15px; cursor: pointer; }
    #parlay button:hover { background: #0d5bb8; }
    #parlay button.secondary { background: #388e3c; font-size: 14px; width: auto; display: inline-block; margin: 5px; }
    #parlay .label { display: inline-block; margin-top: 8px; padding: 4px 10px; background: #e0f7fa; border-radius: 4px; font-weight: bold; color: #006064; }
    #parlay .recommendation { display: inline-block; margin-top: 10px; padding: 6px 12px; border-radius: 6px; font-weight: bold; background: #f3e5f5; color: #4a148c; font-size: 16px; }
    #parlay table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    #parlay th, #parlay td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    #parlay th { background-color: #f0f8ff; }
    #parlay .odds-bandar { background-color: #ffebee; }
    #parlay .odds-adil { background-color: #e8f5e8; }
    #parlay .margin-col { background-color: #fff3e0; }
    #parlay .fair-odds-table { display: none; }
    #parlay .match-controls { text-align: center; margin: 10px 0; }
    #parlay .match-controls button { display: inline-block; margin: 0 5px; }
    #parlay #fairOddsContainer table { display: block; overflow-x: auto; white-space: nowrap; }
    #parlay .risk-high { color: #c62828; }
    #parlay .risk-medium { color: #f57c00; }
    #parlay .risk-low { color: #2e7d32; }
    #parlay .ev-positive { color: #2e7d32; font-weight: bold; }
    #parlay .ev-negative { color: #c62828; font-weight: bold; }
  </style>
</head>
<body>
  <header>
    <h1>üéØ Sistem Analisis Olahraga ‚Äî Realtime</h1>
    <div id="authPanel">
      <span id="userEmail"></span>
      <button id="btnLogout" style="display:none;">Logout</button>
      <button id="btnLogin">Login</button>
    </div>
  </header>
  <div id="loginForm">
    <h3>Login Email</h3>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <p><small>Belum punya akun? Daftar di Firebase Console ‚Üí Authentication</small></p>
  </div>
  <nav id="mainNav" style="display:none;">
    <button data-section="parlay" class="active">1. Analisis Parlay + O/U</button>
    <button data-section="favorit">2. Kumpulan Tim Favorit</button>
    <button data-section="sketsa">3. Sketsa Bil</button>
    <button data-section="diskusi">4. Room Diskusi</button>
    <button data-section="serba">5. Serba Serbi</button>
  </nav>
  <!-- Parlay -->
  <div id="parlay" class="section active">
    <h2>1. Analisis Parlay + Rekomendasi Over/Under (Dapat Disesuaikan)</h2>
    <div id="matches"></div>
    <div class="match-controls">
      <button class="secondary" onclick="tambahPertandingan()">‚ûï Tambah Pertandingan</button>
      <button class="secondary" onclick="hapusPertandingan()">‚ûñ Hapus Pertandingan</button>
    </div>
    <div class="parlay-input">
      <h3>Odds Parlay dari Bandar</h3>
      <input type="number" id="oddsBandarInput" step="0.01" min="1.01" value="30.00" placeholder="Contoh: 30.00">
      <p style="font-size:0.9em; color:#555;">Masukkan odds akumulasi jika ingin analisis parlay (opsional)</p>
      <button class="secondary" onclick="tampilkanOddsAdil()">üëÅÔ∏è Lihat Odds Adil per Laga</button>
    </div>
    <button onclick="hitungParlay()">Hitung Analisis, Parlay & EV</button>
    <button onclick="simpanDataPertandingan()">üíæ Simpan Data Pertandingan</button>
    <button onclick="hapusDataParlay()" style="background:#d32f2f;">üóëÔ∏è Hapus Data Parlay</button>
    <div id="fairOddsContainer" class="fair-odds-table">
      <h3>‚öñÔ∏è Perbandingan: Odds Bandar vs Odds Adil</h3>
      <table>
        <thead>
          <tr>
            <th>Pertandingan</th>
            <th>Outcome</th>
            <th class="odds-bandar">Odds Bandar</th>
            <th class="odds-adil">Odds Adil</th>
            <th class="margin-col">Margin<br>(Bandar ‚Üí Adil)</th>
          </tr>
        </thead>
        <tbody id="fairOddsTableBody"></tbody>
      </table>
    </div>
    <div id="hasil"></div>
  </div>
  <!-- Favorit -->
  <div id="favorit" class="section">
    <h2>2. Kumpulan Tim Favorit</h2>
    <div>
      <input type="text" id="inputTim" placeholder="Contoh: Manchester United">
      <button onclick="tambahTimFavorit()">‚ûï Tambah Tim</button>
    </div>
    <ul id="daftarTim"></ul>
  </div>
  <!-- Sketsa Bil -->
  <div id="sketsa" class="section">
    <h2>3. Sketsa Bil</h2>
    <div class="sketsa-bil">
      <div class="sketsa-bil-section">
        <h2>üìù Fitur Catatan</h2>
        <div id="notes">
          <label for="note1">1.</label><input type="text" id="note1" placeholder="Contoh: juve" />
          <label for="note2">2.</label><input type="text" id="note2" placeholder="Contoh: inter" />
          <label for="note3">3.</label><input type="text" id="note3" placeholder="Contoh: milan" />
          <label for="note4">4.</label><input type="text" id="note4" placeholder="Contoh: roma" />
          <label for="note5">5.</label><input type="text" id="note5" placeholder="Contoh: napoli" />
        </div>
        <button id="saveNotes" class="btn-primary">Simpan Catatan</button>
      </div>
      <div class="sketsa-bil-section">
        <h2>üìä Fitur Collection (9 Tabel)</h2>
        <div id="tablesContainer"></div>
        <button id="saveTables" class="btn-primary">Simpan Semua Tabel</button>
        <button id="deleteAll" class="btn-danger">Hapus Semua Data</button>
      </div>
      <div class="sketsa-bil-section">
        <h2>üßÆ Kalkulator BEP + EV Parlay</h2>
        <p><small>Odds: format desimal (contoh: 1.85)<br>Probabilitas: dalam % (contoh: 60) atau desimal (contoh: 0.6)</small></p>
        <div id="inputs">
          <div class="input-row">
            <input type="text" class="odds" placeholder="Odds (ex: 1.85)" />
            <input type="text" class="prob" placeholder="Prob % atau desimal (ex: 60 atau 0.6)" />
          </div>
        </div>
        <button onclick="tambahBaris()" class="btn-primary">+ Tambah Leg</button>
        <button onclick="hitungEV()" class="btn-success">Hitung BEP & EV</button>
        <div id="hasil-ev">
          <p><strong>Odds Parlay:</strong> <span id="oddsTotal"></span></p>
          <p><strong>BEP:</strong> <span id="bep"></span></p>
          <p><strong>Fair Probability:</strong> <span id="fairProb"></span></p>
          <p><strong>EV:</strong> <span id="ev"></span></p>
          <p><strong>Rekomendasi:</strong> <span id="rekomendasi"></span></p>
        </div>
      </div>
      <div class="sketsa-bil-section">
        <h2>üìÅ Riwayat Perhitungan EV</h2>
        <div id="historyList"></div>
        <button id="clearHistory" class="btn-danger" style="margin-top: 10px;">Hapus Semua Riwayat</button>
      </div>
    </div>
  </div>
  <!-- Diskusi -->
  <div id="diskusi" class="section">
    <h2>4. Room Diskusi ‚Äî Ringkasan Rekomendasi Otomatis</h2>
    <div id="rekomendasi-win" class="rekom-box">
      <h3>‚úÖ Tim untuk Dipilih (Win)</h3>
      <ul id="list-win"></ul>
    </div>
    <div id="rekomendasi-over" class="rekom-box">
      <h3>üìà Pertandingan Over</h3>
      <ul id="list-over"></ul>
    </div>
    <div id="rekomendasi-under" class="rekom-box">
      <h3>üìâ Pertandingan Under</h3>
      <ul id="list-under"></ul>
    </div>
    <p><em>Rekomendasi hanya ditampilkan jika probabilitas ‚â•67% (Win) atau ‚â•60% (Over/Under).</em></p>
  </div>
  <div id="serba" class="section">
    <h2>5. Serba Serbi</h2>
    <p>‚ñ∂Ô∏è Koleksi alat bantu: konversi odds, kalkulator ROI, panduan threshold, dll.</p>
  </div>
  <script>
    // === FIREBASE CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyC5knp2eCkE4pzuNRodN5SgGhaq_H416vE",
      authDomain: "parlaypribadi.firebaseapp.com",
      databaseURL: "https://parlaypribadi-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "parlaypribadi",
      storageBucket: "parlaypribadi.firebasestorage.app",
      messagingSenderId: "42241144949",
      appId: "1:42241144949:web:1bbc9c022c717d4643203c"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    let currentUser = null;
    window.firebaseParlayData = [];

    // === UI AUTH ===
    function updateAuthUI() {
      const loginForm = document.getElementById('loginForm');
      const nav = document.getElementById('mainNav');
      const authPanel = document.getElementById('authPanel');
      const userEmail = document.getElementById('userEmail');
      const btnLogout = document.getElementById('btnLogout');
      const btnLogin = document.getElementById('btnLogin');
      if (currentUser) {
        userEmail.textContent = currentUser.email;
        btnLogout.style.display = 'inline';
        btnLogin.style.display = 'none';
        loginForm.style.display = 'none';
        nav.style.display = 'flex';
      } else {
        userEmail.textContent = '';
        btnLogout.style.display = 'none';
        btnLogin.style.display = 'inline';
        loginForm.style.display = 'block';
        nav.style.display = 'none';
      }
    }
    document.getElementById('btnLogin').onclick = () => {
      document.getElementById('loginForm').style.display = 'block';
    };
    document.getElementById('btnLogout').onclick = () => {
      auth.signOut().then(() => {
        currentUser = null;
        updateAuthUI();
      });
    };
    function login() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      auth.signInWithEmailAndPassword(email, password)
        .catch(err => alert("Login gagal: " + err.message));
    }
    auth.onAuthStateChanged(user => {
      currentUser = user;
      updateAuthUI();
      if (user) {
        initApp(user.uid);
      }
    });

    // === FITUR 1 ‚Äî DIPERBARUI ===
    window.simpanDataPertandingan = function() {
      if (!currentUser) {
        alert("Harap login terlebih dahulu untuk menyimpan ke cloud.");
        return;
      }
      const matchDate = document.getElementById("date1")?.value || "";
      const data = [];
      for (let i = 1; i <= window.jumlahPertandingan; i++) {
        const teamA = document.getElementById(`teamA${i}`)?.value.trim() || `Tim A`;
        const teamB = document.getElementById(`teamB${i}`)?.value.trim() || `Tim B`;
        const oddsA = document.getElementById(`A${i}`)?.value || "0";
        const oddsD = document.getElementById(`D${i}`)?.value || "0";
        const oddsB = document.getElementById(`B${i}`)?.value || "0";
        const over = document.getElementById(`O${i}`)?.value || "0";
        const under = document.getElementById(`U${i}`)?.value || "0";
        data.push({ matchDate, teamA, teamB, oddsA, oddsD, oddsB, over, under });
      }
      firebase.database().ref('users/' + currentUser.uid + '/parlayData').set(data)
        .then(() => {
          window.firebaseParlayData = data;
          alert("‚úÖ Data berhasil disimpan ke Firebase!");
        })
        .catch(err => alert("‚ùå Gagal menyimpan: " + err.message));
    };

    window.hapusDataParlay = function() {
      if (!confirm("Yakin ingin menghapus semua data pertandingan di Fitur 1?")) return;
      if (currentUser) {
        firebase.database().ref('users/' + currentUser.uid + '/parlayData').remove()
          .then(() => {
            window.jumlahPertandingan = 1;
            window.firebaseParlayData = [];
            window.renderPertandingan();
            document.getElementById("hasil").innerHTML = "";
            document.getElementById("fairOddsContainer").style.display = "none";
            alert("‚úÖ Data Fitur 1 telah dihapus dari Firebase.");
          });
      } else {
        localStorage.removeItem('lastMatchData');
        window.jumlahPertandingan = 1;
        window.renderPertandingan();
        alert("‚úÖ Data sementara dihapus.");
      }
    };

    window.renderPertandingan = function() {
      let html = "";
      for (let i = 1; i <= window.jumlahPertandingan; i++) {
        const matchData = window.firebaseParlayData?.[i - 1] || {};
        const matchDate = matchData.matchDate || "";
        const teamA = matchData.teamA || "Tim A";
        const teamB = matchData.teamB || "Tim B";
        const oddsA = matchData.oddsA !== undefined ? matchData.oddsA : "0";
        const oddsD = matchData.oddsD !== undefined ? matchData.oddsD : "0";
        const oddsB = matchData.oddsB !== undefined ? matchData.oddsB : "0";
        const over = matchData.over !== undefined ? matchData.over : "0";
        const under = matchData.under !== undefined ? matchData.under : "0";

        // ‚úÖ HANYA PERTANDINGAN 1 YANG PUNYA INPUT TANGGAL
        let dateInputHtml = "";
        if (i === 1) {
          dateInputHtml = `<div><label>Tanggal:<br><input type="date" id="date1" value="${matchDate}" style="width:120px;text-align:center;"></label></div>`;
        }

        html += `
          <div class="match">
            <h3>Pertandingan ${i}</h3>
            <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:end;">
              ${dateInputHtml}
              <div>
                <label>Nama Tim A:<br>
                  <input type="text" id="teamA${i}" placeholder="Tim A" value="${teamA}" style="width:100px;text-align:center;">
                </label>
              </div>
              <div><label>Odds:<br><input type="number" id="A${i}" value="${oddsA}" step="0.01" min="0"></label></div>
              <div><label>Draw:<br><input type="number" id="D${i}" value="${oddsD}" step="0.01" min="0"></label></div>
              <div>
                <label>Nama Tim B:<br>
                  <input type="text" id="teamB${i}" placeholder="Tim B" value="${teamB}" style="width:100px;text-align:center;">
                </label>
              </div>
              <div><label>Odds:<br><input type="number" id="B${i}" value="${oddsB}" step="0.01" min="0"></label></div>
              <div><label>Over:<br><input type="number" id="O${i}" value="${over}" step="0.01" min="0"></label></div>
              <div><label>Under:<br><input type="number" id="U${i}" value="${under}" step="0.01" min="0"></label></div>
            </div>
            <div id="recOU${i}" style="text-align:center;"></div>
          </div>`;
      }
      document.getElementById("matches").innerHTML = html;

      for (let i = 1; i <= window.jumlahPertandingan; i++) {
        ["A", "D", "B"].forEach(team => {
          const el = document.getElementById(`${team}${i}`);
          if (el) {
            el.addEventListener("input", () => {
              updateOverUnder(i);
              document.getElementById("fairOddsContainer").style.display = "none";
            });
          }
        });
        updateOverUnder(i);
      }
    };

    // === FUNGSI BANTUAN ===
    const MAX_MATCHES = 10;
    window.jumlahPertandingan = 1;

    window.hitungOddsAdil = function(oddsA, oddsDraw, oddsB) {
      const pA = 1 / oddsA;
      const pD = 1 / oddsDraw;
      const pB = 1 / oddsB;
      const total = pA + pD + pB;
      const probAdilA = pA / total;
      const probAdilD = pD / total;
      const probAdilB = pB / total;
      return {
        oddsAdilA: 1 / probAdilA,
        oddsAdilD: 1 / probAdilD,
        oddsAdilB: 1 / probAdilB,
        overround: total,
      };
    };

    window.updateOverUnder = function(idx) {
      const aEl = document.getElementById(`A${idx}`);
      const dEl = document.getElementById(`D${idx}`);
      const bEl = document.getElementById(`B${idx}`);
      const oEl = document.getElementById(`O${idx}`);
      const uEl = document.getElementById(`U${idx}`);
      const recEl = document.getElementById(`recOU${idx}`);

      const a = parseFloat(aEl.value);
      const d = parseFloat(dEl.value);
      const b = parseFloat(bEl.value);

      if (isNaN(a) || isNaN(d) || isNaN(b) || a <= 1 || d <= 1 || b <= 1) {
        oEl.value = "0"; uEl.value = "0";
        if (recEl) recEl.innerHTML = "";
        return;
      }

      const pA = 1 / a, pD = 1 / d, pB = 1 / b;
      const total = pA + pD + pB;
      const probA = pA / total, probD = pD / total, probB = pB / total;
      let avgGoals;
      if (probD >= 0.35) avgGoals = 1.8;
      else if (probD >= 0.25) avgGoals = 2.3;
      else if (Math.abs(probA - probB) >= 0.3) avgGoals = 3.1;
      else avgGoals = 2.6;

      const thresholds = { under15: 2.0, under25: 2.5, over25: 2.7, over35: 3.2 };
      let goalLine, recommendationType;
      if (avgGoals < thresholds.under15) { goalLine = "1.5"; recommendationType = "Under"; }
      else if (avgGoals < thresholds.under25) { goalLine = "2.5"; recommendationType = "Under"; }
      else if (avgGoals < thresholds.over25) { goalLine = "2.5"; recommendationType = "Over"; }
      else if (avgGoals >= thresholds.over35) { goalLine = "3.5"; recommendationType = "Over"; }
      else { goalLine = "2.5"; recommendationType = "Over"; }

      let altLine = "";
      if (avgGoals >= 2.9 && avgGoals < 3.2) altLine = " (atau Over 3/3.5)";
      else if (avgGoals >= 2.4 && avgGoals < 2.7) altLine = " (atau Over 2/2.5)";
      else if (avgGoals >= 2.0 && avgGoals < 2.3) altLine = " (atau Under 2/2.5)";

      let probUnder, probOver;
      if (recommendationType === "Under") {
        probUnder = 0.52 + (thresholds.under25 - avgGoals) * 0.15;
        probUnder = Math.min(0.85, Math.max(0.45, probUnder));
        probOver = 1 - probUnder;
      } else {
        if (goalLine === "3.5") probOver = 0.55 + (avgGoals - thresholds.over35) * 0.12;
        else probOver = 0.52 + (avgGoals - thresholds.under25) * 0.12;
        probOver = Math.min(0.85, Math.max(0.45, probOver));
        probUnder = 1 - probOver;
      }

      const margin = 1.05;
      oEl.value = (1 / probOver * margin).toFixed(2);
      uEl.value = (1 / probUnder * margin).toFixed(2);
      if (recEl) {
        const fullRec = `${recommendationType} ${goalLine}${altLine}`;
        recEl.innerHTML = `<span class="recommendation">Rekomendasi: <strong>${fullRec}</strong></span>`;
      }
    };

    window.tambahPertandingan = function() {
      if (window.jumlahPertandingan < MAX_MATCHES) {
        window.jumlahPertandingan++;
        renderPertandingan();
      } else {
        alert(`Maksimal ${MAX_MATCHES} pertandingan.`);
      }
    };

    window.hapusPertandingan = function() {
      if (window.jumlahPertandingan > 1) {
        window.jumlahPertandingan--;
        renderPertandingan();
      }
    };

    // === FITUR 4 ‚Äî DIPERBARUI DENGAN FILTER ===
    window.tampilkanRekomendasiDiskusi = function() {
      let dataRaw = null;
      if (window.firebaseParlayData && window.firebaseParlayData.length > 0) {
        dataRaw = JSON.stringify(window.firebaseParlayData);
      } else {
        dataRaw = localStorage.getItem('lastMatchData');
      }

      if (!dataRaw) {
        document.getElementById('list-win').innerHTML = '<li><em>Belum ada data dari Fitur 1</em></li>';
        document.getElementById('list-over').innerHTML = '<li><em>-</em></li>';
        document.getElementById('list-under').innerHTML = '<li><em>-</em></li>';
        return;
      }

      const matches = JSON.parse(dataRaw);
      const winList = [];
      const overList = [];
      const underList = [];

      matches.forEach((match, idx) => {
        const { teamA, teamB, oddsA, oddsD, oddsB, over, under } = match;

        // === ANALISIS WIN ===
        const pA = 1 / parseFloat(oddsA);
        const pD = 1 / parseFloat(oddsD);
        const pB = 1 / parseFloat(oddsB);
        const total = pA + pD + pB;
        const probA = pA / total;
        const probB = pB / total;
        const probD = pD / total;

        let timPilihan = "", probPilihan = 0;
        if (probA >= probB && probA >= probD) {
          timPilihan = teamA;
          probPilihan = probA;
        } else if (probB >= probA && probB >= probD) {
          timPilihan = teamB;
          probPilihan = probB;
        } else {
          timPilihan = "Draw";
          probPilihan = probD;
        }

        // ‚úÖ FILTER WIN ‚â•67%
        if (probPilihan >= 0.67) {
          winList.push(`${timPilihan} (${(probPilihan * 100).toFixed(1)}%)`);
        }

        // === ANALISIS OVER/UNDER ===
        const a = parseFloat(oddsA), d = parseFloat(oddsD), b = parseFloat(oddsB);
        if (isNaN(a) || isNaN(d) || isNaN(b) || a <= 1 || d <= 1 || b <= 1) return;

        const pA_raw = 1 / a, pD_raw = 1 / d, pB_raw = 1 / b;
        const total_raw = pA_raw + pD_raw + pB_raw;
        const probA_raw = pA_raw / total_raw;
        const probD_raw = pD_raw / total_raw;
        const probB_raw = pB_raw / total_raw;

        let avgGoals;
        if (probD_raw >= 0.35) avgGoals = 1.8;
        else if (probD_raw >= 0.25) avgGoals = 2.3;
        else if (Math.abs(probA_raw - probB_raw) >= 0.3) avgGoals = 3.1;
        else avgGoals = 2.6;

        const thresholds = { under15: 2.0, under25: 2.5, over25: 2.7, over35: 3.2 };
        let recommendationType, probOver, probUnder;

        if (avgGoals < thresholds.under15) {
          recommendationType = "Under";
          probUnder = 0.52 + (thresholds.under25 - avgGoals) * 0.15;
          probUnder = Math.min(0.85, Math.max(0.45, probUnder));
          probOver = 1 - probUnder;
        } else if (avgGoals < thresholds.under25) {
          recommendationType = "Under";
          probUnder = 0.52 + (thresholds.under25 - avgGoals) * 0.15;
          probUnder = Math.min(0.85, Math.max(0.45, probUnder));
          probOver = 1 - probUnder;
        } else if (avgGoals < thresholds.over25) {
          recommendationType = "Over";
          probOver = 0.52 + (avgGoals - thresholds.under25) * 0.12;
          probOver = Math.min(0.85, Math.max(0.45, probOver));
          probUnder = 1 - probOver;
        } else if (avgGoals >= thresholds.over35) {
          recommendationType = "Over";
          probOver = 0.55 + (avgGoals - thresholds.over35) * 0.12;
          probOver = Math.min(0.85, Math.max(0.45, probOver));
          probUnder = 1 - probOver;
        } else {
          recommendationType = "Over";
          probOver = 0.52 + (avgGoals - thresholds.under25) * 0.12;
          probOver = Math.min(0.85, Math.max(0.45, probOver));
          probUnder = 1 - probOver;
        }

        const pertandingan = `${teamA} vs ${teamB}`;

        // ‚úÖ FILTER OVER ‚â•60%
        if (recommendationType === "Over" && probOver >= 0.60) {
          overList.push(pertandingan + ` (${(probOver * 100).toFixed(1)}%)`);
        }
        // ‚úÖ FILTER UNDER ‚â•60%
        if (recommendationType === "Under" && probUnder >= 0.60) {
          underList.push(pertandingan + ` (${(probUnder * 100).toFixed(1)}%)`);
        }
      });

      // Render
      const winEl = document.getElementById('list-win');
      const overEl = document.getElementById('list-over');
      const underEl = document.getElementById('list-under');

      winEl.innerHTML = winList.length 
        ? winList.map(t => `<li>${t}</li>`).join('') 
        : '<li><em>Tidak ada rekomendasi Win ‚â•67%</em></li>';

      overEl.innerHTML = overList.length 
        ? overList.map(t => `<li>${t}</li>`).join('') 
        : '<li><em>Tidak ada rekomendasi Over ‚â•60%</em></li>';

      underEl.innerHTML = underList.length 
        ? underList.map(t => `<li>${t}</li>`).join('') 
        : '<li><em>Tidak ada rekomendasi Under ‚â•60%</em></li>';
    };

    // === FUNGSI LAINNYA (TIDAK DIUBAH) ===
    window.tampilkanOddsAdil = function() {
      const inputs = [];
      try {
        for (let i = 1; i <= window.jumlahPertandingan; i++) {
          const a = parseFloat(document.getElementById(`A${i}`).value);
          const d = parseFloat(document.getElementById(`D${i}`).value);
          const b = parseFloat(document.getElementById(`B${i}`).value);
          const o = parseFloat(document.getElementById(`O${i}`).value);
          const u = parseFloat(document.getElementById(`U${i}`).value);
          if (isNaN(a) || isNaN(d) || isNaN(b) || a <= 1 || d <= 1 || b <= 1)
            throw new Error("Semua odds 1X2 harus > 1");
          if (isNaN(o) || isNaN(u))
            throw new Error("Over/Under belum terisi");
          inputs.push({ a, d, b, o, u });
        }
        let tableHTML = "";
        inputs.forEach((inp, idx) => {
          const adil1X2 = hitungOddsAdil(inp.a, inp.d, inp.b);
          const outcomes1X2 = [
            { name: "Tim A", bandar: inp.a, adil: adil1X2.oddsAdilA },
            { name: "Draw", bandar: inp.d, adil: adil1X2.oddsAdilD },
            { name: "Tim B", bandar: inp.b, adil: adil1X2.oddsAdilB },
          ];
          outcomes1X2.forEach(out => {
            const margin = (((out.adil - out.bandar) / out.bandar) * 100).toFixed(1);
            tableHTML += `<tr><td>${idx + 1}</td><td>${out.name}</td><td class="odds-bandar">${out.bandar.toFixed(2)}</td><td class="odds-adil">${out.adil.toFixed(2)}</td><td class="margin-col">${margin}%</td></tr>`;
          });
          const pA = 1 / adil1X2.oddsAdilA;
          const pD = 1 / adil1X2.oddsAdilD;
          const pB = 1 / adil1X2.oddsAdilB;
          let probUnderFair = pD + Math.min(pA, pB);
          probUnderFair = Math.min(0.85, Math.max(0.3, probUnderFair));
          const probOverFair = 1 - probUnderFair;
          const oddsUnderFair = 1 / probUnderFair;
          const oddsOverFair = 1 / probOverFair;
          const marginOver = (((oddsOverFair - inp.o) / inp.o) * 100).toFixed(1);
          tableHTML += `<tr><td>${idx + 1}</td><td>Over</td><td class="odds-bandar">${inp.o.toFixed(2)}</td><td class="odds-adil">${oddsOverFair.toFixed(2)}</td><td class="margin-col">${marginOver}%</td></tr>`;
          const marginUnder = (((oddsUnderFair - inp.u) / inp.u) * 100).toFixed(1);
          tableHTML += `<tr><td>${idx + 1}</td><td>Under</td><td class="odds-bandar">${inp.u.toFixed(2)}</td><td class="odds-adil">${oddsUnderFair.toFixed(2)}</td><td class="margin-col">${marginUnder}%</td></tr>`;
        });
        document.getElementById("fairOddsTableBody").innerHTML = tableHTML;
        document.getElementById("fairOddsContainer").style.display = "block";
      } catch (e) {
        alert("Error: " + e.message);
      }
    };

    window.hitungParlay = function() {
      const pertandingan = [];
      try {
        for (let i = 1; i <= window.jumlahPertandingan; i++) {
          const a = parseFloat(document.getElementById(`A${i}`).value);
          const d = parseFloat(document.getElementById(`D${i}`).value);
          const b = parseFloat(document.getElementById(`B${i}`).value);
          if (isNaN(a) || isNaN(d) || isNaN(b))
            throw new Error(`Pertandingan ${i} tidak valid`);
          pertandingan.push({ oddsA: a, oddsDraw: d, oddsB: b });
        }
        const hasilList = pertandingan.map(p => analisisPertandingan(p.oddsA, p.oddsDraw, p.oddsB));
        let resultHTML = "";
        hasilList.forEach((h, idx) => {
          const namaA = document.getElementById(`teamA${idx + 1}`)?.value.trim() || "Tim A";
          const namaB = document.getElementById(`teamB${idx + 1}`)?.value.trim() || "Tim B";
          resultHTML += `
            <div class="match">
              <h3>Pertandingan ${idx + 1}: ${namaA} vs ${namaB}</h3>
              <p><strong>Probabilitas:</strong> ${namaA}: ${h.persentase.timA} | Draw: ${h.persentase.draw} | ${namaB}: ${h.persentase.timB}</p>
              <p><strong>Analisis:</strong> <span class="label">${h.label.replace("Tim A", namaA).replace("Tim B", namaB)}</span></p>
              <p><strong>Pilihan:</strong> ${h.pilihan === "Tim A" ? namaA : (h.pilihan === "Tim B" ? namaB : "Draw")} (${(h.probPilihan * 100).toFixed(2)}%)</p>
            </div>`;
        });
        if (window.jumlahPertandingan === 1) {
          resultHTML += `<div class="parlay-result"><h2>‚ÑπÔ∏è Analisis Tunggal</h2><p>Hanya 1 pertandingan ‚Üí tidak ada parlay atau EV.</p></div>`;
        } else {
          const probGabungan = hasilList.reduce((acc, h) => acc * h.probPilihan, 1);
          const oddsTeoretis = 1 / probGabungan;
          let risiko = "Rendah", riskClass = "risk-low";
          if (probGabungan < 0.05) { risiko = "Sangat Tinggi"; riskClass = "risk-high"; }
          else if (probGabungan < 0.1) { risiko = "Tinggi"; riskClass = "risk-high"; }
          else if (probGabungan < 0.2) { risiko = "Sedang"; riskClass = "risk-medium"; }
          const oddsBandar = parseFloat(document.getElementById("oddsBandarInput").value);
          if (isNaN(oddsBandar) || oddsBandar <= 1) {
            resultHTML += `<div class="parlay-result"><p style="color:red;">‚ö†Ô∏è Odds parlay bandar tidak valid.</p></div>`;
          } else {
            const ev = probGabungan * oddsBandar - 1;
            const rekomendasi = ev > 0 ? "‚úÖ LAYAK (Positive EV)" : "‚ùå TIDAK LAYAK (Negative EV)";
            resultHTML += `
              <div class="parlay-result">
                <h2>üéØ Analisis Parlay & EV</h2>
                <div style="background:#f5f5f5;padding:10px;border-radius:6px;margin:10px 0;">
                  <p><strong>Odds Teoretis:</strong> ${oddsTeoretis.toFixed(2)}</p>
                  <p><strong>Odds Bandar:</strong> ${oddsBandar.toFixed(2)}</p>
                </div>
                <p>Probabilitas Menang Semua: <strong>${(probGabungan * 100).toFixed(2)}%</strong></p>
                <p>Risiko: <strong class="${riskClass}">${risiko}</strong></p>
                <h3>üìä Expected Value (EV)</h3>
                <p>EV = (${(probGabungan * 100).toFixed(2)}% √ó ${oddsBandar}) - 1 = 
                  <span class="${ev > 0 ? 'ev-positive' : 'ev-negative'}">${(ev * 100).toFixed(2)}%</span></p>
                <p><strong>Rekomendasi:</strong> ${rekomendasi}</p>
              </div>`;
          }
        }
        document.getElementById("hasil").innerHTML = resultHTML;
      } catch (e) {
        document.getElementById("hasil").innerHTML = `<p style="color:red;text-align:center;">Error: ${e.message}</p>`;
      }
    };

    window.analisisPertandingan = function(oddsA, oddsDraw, oddsB) {
      if (oddsA <= 1 || oddsDraw <= 1 || oddsB <= 1) throw new Error("Odds harus > 1");
      const pA = 1 / oddsA, pD = 1 / oddsDraw, pB = 1 / oddsB;
      const total = pA + pD + pB;
      const probA = pA / total, probDraw = pD / total, probB = pB / total;
      const pDrawPersen = probDraw * 100, selisihAB = probA - probB;
      let label = "";
      if (pDrawPersen >= 30) label = "Berisiko Seri";
      else if (probA >= 0.55 && selisihAB >= 0.2) label = "Tim A Favorit Kuat";
      else if (probB >= 0.55 && selisihAB <= -0.2) label = "Tim B Favorit Kuat";
      else if (probA > probB) label = "Tim A Diunggulkan";
      else if (probB > probA) label = "Tim B Diunggulkan";
      else label = "Pertandingan Seimbang";
      let pilihan = "", probPilihan = 0;
      if (probA >= probB && probA >= probDraw) { pilihan = "Tim A"; probPilihan = probA; }
      else if (probB >= probA && probB >= probDraw) { pilihan = "Tim B"; probPilihan = probB; }
      else { pilihan = "Draw"; probPilihan = probDraw; }
      return {
        input: { oddsA, oddsDraw, oddsB },
        probabilitas: { timA: probA, draw: probDraw, timB: probB },
        persentase: {
          timA: (probA * 100).toFixed(2) + "%",
          draw: (probDraw * 100).toFixed(2) + "%",
          timB: (probB * 100).toFixed(2) + "%"
        },
        label,
        pilihan,
        probPilihan,
      };
    };

    // === INISIALISASI APLIKASI ===
    function initApp(uid) {
      const userRef = firebase.database().ref('users/' + uid);

      userRef.child('parlayData').on('value', (snapshot) => {
        window.firebaseParlayData = Array.isArray(snapshot.val()) ? snapshot.val() : [];
        if (currentUser) {
          window.jumlahPertandingan = Math.max(1, window.firebaseParlayData.length || 1);
          window.renderPertandingan();
        }
      });

      // === TIM FAVORIT ===
      let daftarTim = [];
      let sedangMengedit = null;
      window.renderDaftarTim = function() {
        const ul = document.getElementById('daftarTim');
        ul.innerHTML = '';
        daftarTim.forEach((tim, idx) => {
          const li = document.createElement('li');
          li.innerHTML = `<span style="flex:1;">${tim}</span>
            <button style="margin:0 5px;" onclick="mulaiEdit(${idx})">‚úèÔ∏è Edit</button>
            <button class="delete" onclick="hapusTim(${idx})">üóëÔ∏è Hapus</button>`;
          ul.appendChild(li);
        });
        const lastData = window.firebaseParlayData.length > 0 ? window.firebaseParlayData : [];
        const allNames = new Set(daftarTim);
        const autoNames = [];
        lastData.forEach(match => {
          if (match.teamA && !allNames.has(match.teamA)) {
            autoNames.push(match.teamA);
            allNames.add(match.teamA);
          }
          if (match.teamB && !allNames.has(match.teamB)) {
            autoNames.push(match.teamB);
            allNames.add(match.teamB);
          }
        });
        autoNames.forEach(name => {
          const li = document.createElement('li');
          li.innerHTML = `<span style="flex:1;color:#555;">${name} <em>(otomatis dari Fitur 1)</em></span>`;
          ul.appendChild(li);
        });
      };
      function simpanDaftarFavoritKeFirebase() {
        userRef.child('timFavorit').set(daftarTim);
      }
      window.tambahTimFavorit = function() {
        const input = document.getElementById('inputTim');
        const nama = input.value.trim();
        if (!nama) { alert("Nama tim tidak boleh kosong!"); return; }
        if (daftarTim.includes(nama) && sedangMengedit === null) { alert('Tim sudah ada!'); return; }
        if (sedangMengedit !== null) {
          daftarTim[sedangMengedit] = nama;
          sedangMengedit = null;
        } else {
          daftarTim.push(nama);
        }
        input.value = '';
        window.renderDaftarTim();
        simpanDaftarFavoritKeFirebase();
      };
      window.mulaiEdit = function(idx) {
        document.getElementById('inputTim').value = daftarTim[idx];
        sedangMengedit = idx;
      };
      window.hapusTim = function(idx) {
        daftarTim.splice(idx, 1);
        if (sedangMengedit === idx) sedangMengedit = null;
        window.renderDaftarTim();
        simpanDaftarFavoritKeFirebase();
      };
      userRef.child('timFavorit').on('value', (snapshot) => {
        daftarTim = Array.isArray(snapshot.val()) ? snapshot.val() : [];
        window.renderDaftarTim();
      });

      // === NOTES & TABEL ===
      document.getElementById('saveNotes').addEventListener('click', () => {
        const notes = {
          1: document.getElementById('note1').value.trim(),
          2: document.getElementById('note2').value.trim(),
          3: document.getElementById('note3').value.trim(),
          4: document.getElementById('note4').value.trim(),
          5: document.getElementById('note5').value.trim(),
        };
        userRef.child('notes').set(notes).then(() => renderTablesFirebase());
      });
      userRef.child('notes').on('value', (snapshot) => {
        const notes = snapshot.val() || {};
        ['1','2','3','4','5'].forEach(i => {
          document.getElementById(`note${i}`).value = notes[i] || '';
        });
      });

      window.renderTablesFirebase = function() {
        const notesMap = {};
        userRef.child('notes').once('value').then(snapshot => {
          const notes = snapshot.val() || {};
          [1,2,3,4,5].forEach(i => notesMap[i] = notes[i] || '');
          userRef.child('tables').once('value').then(snapshot => {
            const savedData = snapshot.val() || null;
            const container = document.getElementById('tablesContainer');
            container.innerHTML = '';
            const labelTopRight = notesMap[1] || 'Catatan 1';
            const tableConfigs = [
              [[null, null], [3, 'win'], [5, 'win']],
              [[null, null], [3, 'win'], [4, 'win']],
              [[null, null], [3, 'win'], [5, 'remis']],
              [[null, null], [2, 'win'], [4, 'win']],
              [[null, null], [2, 'win'], [5, 'win']],
              [[null, null], [2, 'win'], [4, 'remis']],
              [[null, null], [3, 'remis'], [4, 'win']],
              [[null, null], [3, 'remis'], [5, 'win']],
              [[null, null], [2, 'remis'], [5, 'remis']],
            ];
            for (let i = 0; i < 9; i++) {
              const baseData = tableConfigs[i].map(row => [...row]);
              if (savedData && savedData[i] && savedData[i][0]) {
                baseData[0] = [savedData[i][0][0] || '', savedData[i][0][1] || ''];
              }
              const tableContainer = document.createElement('div');
              tableContainer.className = 'table-container';
              const labelEl = document.createElement('div');
              labelEl.className = 'table-label';
              labelEl.textContent = labelTopRight;
              tableContainer.appendChild(labelEl);
              const tableDiv = document.createElement('div');
              tableDiv.innerHTML = `<strong>Tabel ${i + 1}</strong>`;
              const table = document.createElement('table');
              const tbody = document.createElement('tbody');
              for (let r = 0; r < 3; r++) {
                const row = document.createElement('tr');
                const cell1 = document.createElement('td');
                if (r === 0) {
                  const input1 = document.createElement('input');
                  input1.type = 'text';
                  input1.value = baseData[r][0] || '';
                  input1.dataset.table = i;
                  input1.dataset.row = r;
                  input1.dataset.col = 0;
                  input1.style.width = '100%';
                  cell1.appendChild(input1);
                } else {
                  const num = baseData[r][0];
                  const displayText = notesMap[num] || num;
                  cell1.textContent = displayText;
                }
                row.appendChild(cell1);
                const cell2 = document.createElement('td');
                if (r === 0) {
                  const input2 = document.createElement('input');
                  input2.type = 'text';
                  input2.value = baseData[r][1] || '';
                  input2.dataset.table = i;
                  input2.dataset.row = r;
                  input2.dataset.col = 1;
                  input2.style.width = '100%';
                  cell2.appendChild(input2);
                } else {
                  cell2.textContent = baseData[r][1];
                  cell2.style.backgroundColor = '#f9f9f9';
                  cell2.style.fontWeight = 'bold';
                }
                row.appendChild(cell2);
                tbody.appendChild(row);
              }
              table.appendChild(tbody);
              tableDiv.appendChild(table);
              tableContainer.appendChild(tableDiv);
              container.appendChild(tableContainer);
            }
          });
        });
      };

      document.getElementById('saveTables').addEventListener('click', () => {
        const inputs = document.querySelectorAll('#tablesContainer input[data-row="0"]');
        const tablesData = Array(9).fill().map(() => [[null, null], [null, null], [null, null]]);
        inputs.forEach(input => {
          const t = parseInt(input.dataset.table);
          const c = parseInt(input.dataset.col);
          tablesData[t][0][c] = input.value.trim();
        });
        userRef.child('tables').set(tablesData);
      });

      document.getElementById('deleteAll').addEventListener('click', () => {
        if (confirm('Hapus semua data permanen?')) {
          userRef.remove().then(() => location.reload());
        }
      });

      // Riwayat EV
      window.tampilkanRiwayatFirebase = function() {
        userRef.child('evHistory').once('value').then(snapshot => {
          const history = snapshot.val() || [];
          const container = document.getElementById('historyList');
          container.innerHTML = history.length === 0 ? '<p><em>Belum ada riwayat.</em></p>' : '';
          history.forEach((item, index) => {
            const evValue = parseFloat(item.ev);
            const evColor = evValue > 0 ? 'positive' : evValue < 0 ? 'negative' : 'neutral';
            const div = document.createElement('div');
            div.style.cssText = 'border:1px solid #eee;padding:12px;margin-bottom:10px;border-radius:6px;background:#fafafa;';
            div.innerHTML = `
              <strong>Odds:</strong> ${item.oddsTotal} | <strong>EV:</strong> <span class="${evColor}">${item.ev}</span><br>
              <small>Input: Odds [${item.oddsList.join(', ')}] | Prob [${item.probList.map(p => (p*100).toFixed(1)+'%').join(', ')}]</small>
              <div style="margin-top:8px;">
                <button onclick="editEntry(${index})" style="padding:6px 10px;font-size:12px;">‚úèÔ∏è Edit</button>
                <button onclick="hapusEntry(${index})" style="padding:6px 10px;font-size:12px;">üóëÔ∏è Hapus</button>
              </div>
            `;
            container.appendChild(div);
          });
        });
      };

      window.renderTablesFirebase();
      window.tampilkanRiwayatFirebase();
    }

    // === NAVIGASI ===
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('#mainNav button').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('#mainNav button').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
          button.classList.add('active');
          const target = document.getElementById(button.dataset.section);
          target.classList.add('active');
          if (button.dataset.section === 'parlay') {
            window.renderPertandingan();
          }
          if (button.dataset.section === 'diskusi') {
            window.tampilkanRekomendasiDiskusi();
          }
          if (button.dataset.section === 'favorit') {
            window.renderDaftarTim();
          }
        });
      });
    });

    // Render awal
    window.renderPertandingan();
  </script>
</body>
</html>
