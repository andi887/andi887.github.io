
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Toto App - Mul1 Final</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    body { background: #f5f5f5; padding: 8px; color: #333; }
    .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .screen { animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .btn { padding: 12px; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin: 6px 0; font-size: 16px; }
    .btn-home { background: #1a73e8; }
    .btn-back { background: #5f6368; }
    .btn-save { background: #0f9d58; }
    .btn-delete { background: #ea4335; }
    .btn-add { background: #fb8c00; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #e8f0fe; }
    input[type="date"], input[type="text"] { width: 100%; padding: 6px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
    .modal-content { background: white; margin: 15% auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; position: relative; }
    .close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #999; }
    h3, h4 { text-align: center; margin: 12px 0; color: #1a73e8; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Beranda -->
    <div id="home" class="screen">
      <h3>Beranda</h3>
      <button class="btn btn-home" onclick="openFeature('sd')">1. SD</button>
      <button class="btn btn-home" onclick="openFeature('cn')">2. CN</button>
      <button class="btn btn-home" onclick="openFeature('singa')">3. Singa</button>
      <button class="btn btn-home" onclick="openFeature('thaiw')">4. Thaiw</button>
      <button class="btn btn-home" onclick="openFeature('hk')">5. HK</button>
    </div>

    <!-- Halaman Fitur -->
    <div id="feature" class="screen hidden">
      <button class="btn btn-back" onclick="showScreen('home')">Kembali</button>
      <h3 id="feature-title">SD</h3>

      <!-- Tabel 1 -->
      <h4>Tabel 1: Input RES</h4>
      <button class="btn btn-add" onclick="addRowTable1()">+ Tambah Baris</button>
      <table id="table1">
        <thead><tr><th>Waktu</th><th>Hari</th><th>RES</th><th>Aksi</th></tr></thead>
        <tbody id="tbody1"></tbody>
      </table>

      <!-- Tabel 2 -->
      <h4>Tabel 2: Acuan</h4>
      <table id="table2">
        <thead><tr><th>Acuan</th><th>Jari</th><th>RES</th><th>Ket</th></tr></thead>
        <tbody id="tbody2"></tbody>
      </table>

      <!-- Tabel 3 -->
      <h4>Tabel 3: Lampiran</h4>
      <table id="table3">
        <thead><tr><th>RES</th><th>Lampiran</th></tr></thead>
        <tbody id="tbody3"></tbody>
      </table>

      <button class="btn btn-save" onclick="saveAll()">Simpan</button>
    </div>
  </div>

  <!-- Modal Popup -->
  <div id="popupModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h4 id="popupTitle">Keterangan</h4>
      <p id="popupContent"></p>
    </div>
  </div>

  <script>
    // === Firebase Config (sesuai permintaan) ===
    const firebaseConfig = {
      apiKey: "AIzaSyALc-1SYjzRUcB-Ws01rab1mxlmcv2e6dA",
      authDomain: "nomoromosse.firebaseapp.com",
      databaseURL: "https://nomoromosse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nomoromosse",
      storageBucket: "nomoromosse.firebasestorage.app",
      messagingSenderId: "985183830784",
      appId: "1:985183830784:web:fae21bdb94c1f0103769e5"
    };

    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('mul1Data');

    const MARKETS = { sd: 'SD', cn: 'CN', singa: 'Singa', thaiw: 'Thaiw', hk: 'HK' };
    const FIXED_REF = ['B','C','D','G','H','I','J','K','R','Y','A','M','N'];
    const DAYS = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];

    let currentMarket = 'sd';
    let appData = {
      sd: { entries: [] },
      cn: { entries: [] },
      singa: { entries: [] },
      thaiw: { entries: [] },
      hk: { entries: [] }
    };

    // Muat data dari Firebase
    dbRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data) {
        Object.keys(appData).forEach(key => {
          if (data[key] && data[key].entries) {
            appData[key].entries = data[key].entries;
          }
        });
        if (!document.getElementById('feature').classList.contains('hidden')) {
          renderAllTables();
        }
      }
    });

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function openFeature(market) {
      currentMarket = market;
      document.getElementById('feature-title').textContent = MARKETS[market];
      renderAllTables();
      showScreen('feature');
    }

    // === Tabel 1 ===
    function addRowTable1(date = '', res = '') {
      const d = date ? new Date(date) : null;
      const day = date && !isNaN(d) ? DAYS[d.getDay()] : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="date" value="${date}" class="date-input"></td>
        <td class="day-cell">${day}</td>
        <td><input type="text" value="${res}" class="res-input" maxlength="4" placeholder="1234"></td>
        <td><button class="btn btn-delete" onclick="removeRow(this)">Hapus</button></td>
      `;
      const dateInput = tr.querySelector('.date-input');
      const dayCell = tr.querySelector('.day-cell');
      dateInput.addEventListener('change', () => {
        const d = new Date(dateInput.value);
        dayCell.textContent = dateInput.value && !isNaN(d) ? DAYS[d.getDay()] : '';
      });
      const resInput = tr.querySelector('.res-input');
      resInput.addEventListener('input', () => {
        resInput.value = resInput.value.replace(/\D/g, '').slice(0, 4);
      });
      document.getElementById('tbody1').appendChild(tr);
    }

    function removeRow(btn) {
      btn.closest('tr').remove();
    }

    // === Render Semua Tabel ===
    function renderAllTables() {
      const tbody1 = document.getElementById('tbody1');
      tbody1.innerHTML = '';
      appData[currentMarket].entries.forEach(entry => {
        addRowTable1(entry.date, entry.res);
      });
      renderTable2And3();
    }

    function renderTable2And3() {
      const tbody2 = document.getElementById('tbody2');
      const tbody3 = document.getElementById('tbody3');
      tbody2.innerHTML = '';
      tbody3.innerHTML = '';

      const entries = appData[currentMarket].entries;
      if (entries.length === 0) return;

      entries.forEach((entry, idx) => {
        // Tabel 2: 13 baris per entry
        FIXED_REF.forEach((ref, i) => {
          // Ambil nilai jari dari data asli (untuk disimpan), tapi tampilkan kosong saat pertama kali render setelah simpan
          const jariValue = entry.jari?.[ref] || '';
          const tr2 = document.createElement('tr');
          tr2.innerHTML = `
            <td>${ref}</td>
            <td><input type="text" class="jari-input" value="${jariValue}" maxlength="2" placeholder="x/0-99"></td>
            <td>${entry.res || ''}</td>
            <td>${i === 0 ? '<span class="ket-link" data-idx="' + idx + '">ket</span>' : ''}</td>
          `;
          tbody2.appendChild(tr2);

          const jariInput = tr2.querySelector('.jari-input');
          jariInput.dataset.ref = ref;
          jariInput.dataset.idx = idx;
          jariInput.addEventListener('input', function() {
            let val = this.value.trim().toLowerCase();
            if (val === 'x' || val === '') {
              this.value = val;
            } else {
              val = val.replace(/\D/g, '').slice(0, 2);
              this.value = val;
            }
          });
        });

        // Tabel 3
        const tr3 = document.createElement('tr');
        tr3.innerHTML = `
          <td>${entry.res || ''}</td>
          <td><span class="lampiran-link" data-idx="${idx}">Lampiran 1</span></td>
        `;
        tbody3.appendChild(tr3);
      });

      // Pasang event popup
      document.querySelectorAll('.ket-link, .lampiran-link').forEach(el => {
        el.addEventListener('click', function() {
          const idx = this.dataset.idx;
          const entry = appData[currentMarket].entries[idx];
          if (!entry) return;

          const items = FIXED_REF.map(ref => {
            const j = entry.jari?.[ref] || '?';
            return `${ref} ${j}`;
          });
          document.getElementById('popupTitle').textContent = `${entry.res} - Detail`;
          document.getElementById('popupContent').textContent = `${entry.res} ${items.join(', ')}`;
          document.getElementById('popupModal').style.display = 'block';
        });
      });
    }

    // === Simpan Semua (dengan reset UI jari setelah simpan) ===
    function saveAll() {
      const rows = document.querySelectorAll('#tbody1 tr');
      const newEntries = [];

      rows.forEach(row => {
        const dateInput = row.querySelector('.date-input');
        const resInput = row.querySelector('.res-input');
        if (!dateInput || !resInput) return;
        const date = dateInput.value;
        const res = resInput.value.trim();
        if (date && res && /^\d{4}$/.test(res)) {
          // Ambil nilai jari terkini dari input
          const jari = {};
          document.querySelectorAll('.jari-input').forEach(input => {
            const ref = input.dataset.ref;
            const val = input.value.trim();
            if (val === 'x' || /^\d{1,2}$/.test(val)) {
              jari[ref] = val;
            }
          });
          newEntries.push({ date, res, jari });
        }
      });

      // Simpan ke Firebase
      appData[currentMarket].entries = newEntries;
      dbRef.child(currentMarket).set({ entries: newEntries }).then(() => {
        alert(`Data ${MARKETS[currentMarket]} berhasil disimpan!`);

        // ✅ PENTING: Kosongkan kolom "jari" di tampilan (UI saja), data tetap tersimpan
        document.querySelectorAll('.jari-input').forEach(input => {
          input.value = '';
        });

        // Refresh Tabel 3 agar tetap akurat
        renderTable3Only();
      }).catch(err => {
        alert('Gagal menyimpan: ' + err.message);
      });
    }

    // Render hanya Tabel 3 (setelah simpan)
    function renderTable3Only() {
      const tbody3 = document.getElementById('tbody3');
      tbody3.innerHTML = '';

      const entries = appData[currentMarket].entries;
      entries.forEach((entry, idx) => {
        const tr3 = document.createElement('tr');
        tr3.innerHTML = `
          <td>${entry.res || ''}</td>
          <td><span class="lampiran-link" data-idx="${idx}">Lampiran 1</span></td>
        `;
        tbody3.appendChild(tr3);
      });

      document.querySelectorAll('.lampiran-link').forEach(el => {
        el.addEventListener('click', function() {
          const idx = this.dataset.idx;
          const entry = appData[currentMarket].entries[idx];
          if (!entry) return;

          const items = FIXED_REF.map(ref => {
            const j = entry.jari?.[ref] || '?';
            return `${ref} ${j}`;
          });
          document.getElementById('popupTitle').textContent = `${entry.res} - Lampiran`;
          document.getElementById('popupContent').textContent = `${entry.res} ${items.join(', ')}`;
          document.getElementById('popupModal').style.display = 'block';
        });
      });
    }

    function closeModal() {
      document.getElementById('popupModal').style.display = 'none';
    }

    window.onclick = function(e) {
      if (e.target === document.getElementById('popupModal')) closeModal();
    };
  </script>
</body>
</html>
