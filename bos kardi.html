<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nota - Andika Jaya</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9f9;
      padding: 12px;
      margin: 0;
    }

    .container {
      max-width: 900px;
      margin: 0 auto 24px;
      background: white;
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 18px;
    }

    .header h1 {
      margin: 5px 0;
      font-size: 20px;
      color: #2c3e50;
    }

    .header p {
      margin: 3px 0;
      color: #555;
      font-size: 14px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      min-width: 120px;
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      text-align: center;
    }

    .btn:hover {
      background-color: #2980b9;
    }

    .btn-danger {
      background-color: #e74c3c;
    }

    .btn-danger:hover {
      background-color: #c0392b;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .info-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .info-row > div {
      width: 100%;
    }

    .info-row label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
      color: #333;
      font-size: 14px;
    }

    .info-row input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }

    th {
      background-color: #f1f1f1;
      font-weight: bold;
      color: #2c3e50;
    }

    @media (min-width: 768px) {
      table th:nth-child(1), table td:nth-child(1) { width: 8%; }
      table th:nth-child(2), table td:nth-child(2) { width: 47%; }
      table th:nth-child(3), table td:nth-child(3) { width: 15%; }
      table th:nth-child(4), table td:nth-child(4) { width: 30%; }
    }

    @media (max-width: 767px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }

      thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }

      tr {
        border: 1px solid #ccc;
        padding: 12px 0;
        margin-bottom: 12px;
        border-radius: 8px;
        background: #fafafa;
      }

      td {
        text-align: right;
        padding: 8px 12px !important;
        position: relative;
        border: none;
      }

      td:before {
        content: attr(data-label) ": ";
        position: absolute;
        left: 12px;
        font-weight: bold;
        color: #2c3e50;
      }

      .total-row {
        font-size: 16px;
      }
    }

    .total-row {
      text-align: right;
      margin-top: 16px;
      font-size: 18px;
      font-weight: bold;
    }

    .signature {
      display: flex;
      flex-direction: column;
      gap: 30px;
      margin-top: 30px;
    }

    .signature div {
      width: 100%;
    }

    .signature p {
      margin-top: 20px;
      border-top: 1px solid #000;
      padding-top: 5px;
      text-align: center;
      font-size: 14px;
    }

    #tombol-global {
      text-align: center;
      margin-bottom: 20px;
      display: none; /* hanya disembunyikan saat belum login */
    }

    #logout-container {
      text-align: right;
      padding: 10px 12px 0;
      display: none;
    }

    #catatan-section {
      display: none;
      margin-bottom: 20px;
    }

    #catatan-text {
      width: 100%;
      height: 100px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"] {
      font-size: 16px;
    }

    /* Login Screen */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
      box-sizing: border-box;
    }

    #login-screen h2 {
      margin-bottom: 20px;
      color: #2c3e50;
    }

    #login-screen input {
      width: 100%;
      max-width: 300px;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    #login-screen button {
      margin-top: 15px;
      padding: 12px 30px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }

    #login-error {
      margin-top: 15px;
      color: #e74c3c;
    }

    /* Rekap Container */
    #rekap-container {
      display: none;
      max-width: 900px;
      margin: 0 auto;
      padding: 12px;
    }

    /* Modal Detail Nota */
    #modal-detail {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    #modal-content {
      background: white;
      width: 95%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px;
      padding-top: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;
    }

    .modal-header {
      text-align: center;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
    }

    .modal-header h2 {
      margin: 0;
      color: #2c3e50;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      left: 15px;
      font-size: 28px;
      cursor: pointer;
      color: #777;
      font-weight: bold;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: #f1f1f1;
    }

    .close-modal:hover {
      color: #e74c3c;
      background: #ffeded;
    }

    #modal-body {
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 15px;
      line-height: 1.6;
      background: #f9f9f9;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen">
  <h2>Login Nota - Andika Jaya</h2>
  <input type="text" id="username" placeholder="ID User" autocomplete="off">
  <input type="password" id="password" placeholder="Sandi">
  <button onclick="login()">Masuk</button>
  <p id="login-error"></p>
</div>

<!-- Logout Button -->
<div id="logout-container">
  <button class="btn" onclick="logout()" style="background: #95a5a6; padding: 6px 12px; font-size: 13px;">üö™ Logout</button>
</div>

<!-- Tombol Global: TETAP TAMPIL UNTUK SEMUA ROLE -->
<div id="tombol-global">
  <button class="btn" id="tambah-nota-global">‚ûï Tambah Nota Baru</button>
  <button class="btn" id="lihat-rekap" style="background-color: #2ecc71;">üìä Rekap Penjualan</button>
</div>

<!-- Kolom Catatan -->
<div id="catatan-section">
  <div class="container" style="padding: 15px;">
    <h3 style="margin-top: 0; color: #2c3e50; font-size: 16px;">üìù Catatan Umum</h3>
    <textarea id="catatan-text" placeholder="Tulis catatan di sini... (tersimpan otomatis)"></textarea>
    <div style="text-align: right; margin-top: 8px; font-size: 12px; color: #777;">
      <span id="catatan-status">Menunggu...</span>
    </div>
  </div>
</div>

<!-- Rekap Container -->
<div id="rekap-container">
  <div class="container">
    <h2 style="text-align: center; color: #2c3e50;">üìä Rekap Penjualan</h2>
    <button class="btn" onclick="tutupRekap()" style="background: #95a5a6; margin-bottom: 16px;">‚¨ÖÔ∏è Kembali</button>
    <div id="daftar-rekap">
      <p>Memuat data rekap...</p>
    </div>
  </div>
</div>

<!-- Modal Detail Nota -->
<div id="modal-detail">
  <div id="modal-content">
    <div class="close-modal" onclick="tutupModal()">√ó</div>
    <div class="modal-header">
      <h2>üìÑ Isi Nota</h2>
    </div>
    <div id="modal-body">
    </div>
  </div>
</div>

<datalist id="jenisBarangList">
  <option value="BDG">
  <option value="kKB">
  <option value="Myung">
  <option value="tawar">
  <option value="mubara">
  <option value="bawel">
  <option value="mondo">
  <option value="daun">
  <option value="krong">
  <option value="hiu">
  <option value="iMERA">
  <option value="BNN">
  <option value="TGR">
  <option value="KPUTI">
  <option value="sarisi">
  <option value="lajur">
  <option value="lasi">
  <option value="TOKI">
  <option value="TGIRI">
  <option value="DLL">
</datalist>

<!-- Template Nota -->
<div class="container nota-template">
  <div class="header">
    <h1>ANDIKA JAYA</h1>
    <p>Alamat: Jl. Poros Pomako, Mimika Timur Papua.</p>
    <p>üìû 0853 1500 7433</p>
  </div>

  <div class="button-group">
    <button class="btn simpan-nota">üíæ Simpan Data</button>
    <button class="btn btn-danger hapus-nota">üóëÔ∏è Hapus Nota</button>
  </div>

  <div class="info-row">
    <div><label>NOTA NO</label><input type="text" class="nota-no" placeholder="Nomor Nota"></div>
    <div><label>Waktu</label><input type="date" class="waktu-nota"></div>
    <div><label>Kepada Yth</label><input type="text" class="kepada" placeholder="Nama Pelanggan"></div>
    <div><label>Tujuan</label><input type="text" class="tujuan" placeholder="Tujuan Pengiriman"></div>
    <div><label>Toko</label><input type="text" class="toko" placeholder="Nama Toko"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>J BRNG</th>
        <th>Jenis Barang</th>
        <th>Harga Satuan</th>
        <th>Total Harga</th>
      </tr>
    </thead>
    <tbody>
      <tr><td data-label="J BRNG"><input type="number" class="banyaknya" min="0" value="0"></td><td data-label="Jenis Barang"><input type="text" class="barang" list="jenisBarangList" placeholder="Jenis barang"></td><td data-label="Harga Satuan"><input type="number" class="harga" min="0" value="0"></td><td data-label="Total Harga" class="total">0</td></tr>
      <tr><td data-label="J BRNG"><input type="number" class="banyaknya" min="0" value="0"></td><td data-label="Jenis Barang"><input type="text" class="barang" list="jenisBarangList" placeholder="Jenis barang"></td><td data-label="Harga Satuan"><input type="number" class="harga" min="0" value="0"></td><td data-label="Total Harga" class="total">0</td></tr>
      <tr><td data-label="J BRNG"><input type="number" class="banyaknya" min="0" value="0"></td><td data-label="Jenis Barang"><input type="text" class="barang" list="jenisBarangList" placeholder="Jenis barang"></td><td data-label="Harga Satuan"><input type="number" class="harga" min="0" value="0"></td><td data-label="Total Harga" class="total">0</td></tr>
      <tr><td data-label="J BRNG"><input type="number" class="banyaknya" min="0" value="0"></td><td data-label="Jenis Barang"><input type="text" class="barang" list="jenisBarangList" placeholder="Jenis barang"></td><td data-label="Harga Satuan"><input type="number" class="harga" min="0" value="0"></td><td data-label="Total Harga" class="total">0</td></tr>
      <tr><td data-label="J BRNG"><input type="number" class="banyaknya" min="0" value="0"></td><td data-label="Jenis Barang"><input type="text" class="barang" list="jenisBarangList" placeholder="Jenis barang"></td><td data-label="Harga Satuan"><input type="number" class="harga" min="0" value="0"></td><td data-label="Total Harga" class="total">0</td></tr>
      <tr><td data-label="J BRNG"><input type="number" class="banyaknya" min="0" value="0"></td><td data-label="Jenis Barang"><input type="text" class="barang" list="jenisBarangList" placeholder="Jenis barang"></td><td data-label="Harga Satuan"><input type="number" class="harga" min="0" value="0"></td><td data-label="Total Harga" class="total">0</td></tr>
      <tr><td data-label="J BRNG"><input type="number" class="banyaknya" min="0" value="0"></td><td data-label="Jenis Barang"><input type="text" class="barang" list="jenisBarangList" placeholder="Jenis barang"></td><td data-label="......Harga Satuan"><input type="number" class="harga" min="0" value="0"></td><td data-label="Total Harga" class="total">0</td></tr>
      <tr><td data-label="J BRNG"><input type="number" class="banyaknya" min="0" value="0"></td><td data-label="Jenis Barang"><input type="text" class="barang" list="jenisBarangList" placeholder="Jenis barang"></td><td data-label="Harga Satuan"><input type="number" class="harga" min="0" value="0"></td><td data-label="Total Harga" class="total">0</td></tr>
      <tr><td data-label="J BRNG"><input type="number" class="banyaknya" min="0" value="0"></td><td data-label="Jenis Barang"><input type="text" class="barang" list="jenisBarangList" placeholder="Jenis barang"></td><td data-label="Harga Satuan"><input type="number" class="harga" min="0" value="0"></td><td data-label="Total Harga" class="total">0</td></tr>
      <tr><td data-label="J BRNG"><input type="number" class="banyaknya" min="0" value="0"></td><td data-label="Jenis Barang"><input type="text" class="barang" list="jenisBarangList" placeholder="Jenis barang"></td><td data-label="Harga Satuan"><input type="number" class="harga" min="0" value="0"></td><td data-label="Total Harga" class="total">0</td></tr>
    </tbody>
  </table>

  <div class="total-row">
    Total (Rp): <span class="grand-total">0</span>
  </div>

  <div class="signature">
    <div><p>Tanda Terima,</p></div>
    <div><p>Hormat Kami,<br><strong>ANDIKA JAYA</strong></p></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyANLV4G5irPCO6sCSO1iMZSImctS-jTWaA",
    authDomain: "mimikaberjaya.firebaseapp.com",
    databaseURL: "https://mimikaberjaya-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mimikaberjaya",
    storageBucket: "mimikaberjaya.firebasestorage.app",
    messagingSenderId: "879618299261",
    appId: "1:879618299261:web:4d8c3e67fb7e3708a82814"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const notaRef = db.ref('notas');
  const notesRef = db.ref('notes/general');

  let currentUser = null;
  const validUsers = {
    'kardi': { password: 'andika', role: 'admin' },
    'herman': { password: 'kapal', role: 'user' }
  };

  function login() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    const err = document.getElementById('login-error');
    err.textContent = '';

    if (validUsers[u] && validUsers[u].password === p) {
      currentUser = { id: u, role: validUsers[u].role };
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('logout-container').style.display = 'block';
      document.getElementById('catatan-section').style.display = 'block';
      document.getElementById('tombol-global').style.display = 'block';

      // Pasang event listener ‚Äî semua tombol tetap aktif secara UI
      document.getElementById('tambah-nota-global').onclick = () => {
        if (currentUser.role === 'admin') {
          buatNotaBaru();
        } else {
          alert('‚ÑπÔ∏è Hanya admin yang dapat menambah nota baru.');
        }
      };
      document.getElementById('lihat-rekap').onclick = tampilkanRekap;

      muatSemuaNota();
      muatCatatan();
    } else {
      err.textContent = 'ID atau sandi salah!';
    }
  }

  document.getElementById('password').addEventListener('keypress', e => {
    if (e.key === 'Enter') login();
  });

  function logout() {
    currentUser = null;
    document.getElementById('logout-container').style.display = 'none';
    document.getElementById('catatan-section').style.display = 'none';
    document.getElementById('tombol-global').style.display = 'none';
    document.getElementById('rekap-container').style.display = 'none';
    document.getElementById('modal-detail').style.display = 'none';
    document.querySelectorAll('.container:not(.nota-template)').forEach(el => el.remove());
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('login-error').textContent = '';
  }

  document.addEventListener('DOMContentLoaded', function () {
    const brokenCell = document.querySelector('.nota-template tbody tr:nth-child(7) td:nth-child(3)');
    if (brokenCell && brokenCell.hasAttribute('data-label......')) {
      brokenCell.setAttribute('data-label', 'Harga Satuan');
      brokenCell.removeAttribute('data-label......');
    }
    window.templateNota = document.querySelector('.nota-template').cloneNode(true);
    document.querySelector('.nota-template').remove();
  });

  function hitungTotalBaris(row) {
    const qty = parseFloat(row.querySelector('.banyaknya').value) || 0;
    const harga = parseFloat(row.querySelector('.harga').value) || 0;
    const total = qty * harga;
    row.querySelector('.total').textContent = total.toLocaleString('id-ID');
    return total;
  }

  function hitungGrandTotal(container) {
    let sum = 0;
    container.querySelectorAll('tbody tr').forEach(r => sum += hitungTotalBaris(r));
    container.querySelector('.grand-total').textContent = sum.toLocaleString('id-ID');
  }

  function pasangEventListener(container) {
    container.addEventListener('input', e => {
      if (e.target.classList.contains('banyaknya') || e.target.classList.contains('harga')) {
        hitungGrandTotal(container);
      }
    });
  }

  function simpanNota(container) {
    if (currentUser?.role !== 'admin') {
      alert('‚ÑπÔ∏è Hanya admin yang dapat menyimpan nota.');
      return;
    }

    const id = container.dataset.notaId || 'nota-' + Date.now();
    const now = Date.now();

    const data = {
      notaNo: container.querySelector('.nota-no').value,
      waktu: container.querySelector('.waktu-nota').value,
      kepada: container.querySelector('.kepada').value,
      tujuan: container.querySelector('.tujuan').value,
      toko: container.querySelector('.toko').value,
      items: []
    };

    let grandTotal = 0;
    container.querySelectorAll('tbody tr').forEach(row => {
      const qty = parseFloat(row.querySelector('.banyaknya').value) || 0;
      const harga = parseFloat(row.querySelector('.harga').value) || 0;
      const total = qty * harga;
      grandTotal += total;
      data.items.push({
        banyaknya: row.querySelector('.banyaknya').value,
        barang: row.querySelector('.barang').value,
        harga: row.querySelector('.harga').value
      });
    });

    notaRef.child(id).set(data)
      .then(() => {
        alert('‚úÖ Nota berhasil disimpan!');
        const rekapRef = db.ref('rekap');
        const rekapData = {
          notaId: id,
          notaNo: data.notaNo || '‚Äî',
          waktu: data.waktu || '',
          kepada: data.kepada || '‚Äî',
          tujuan: data.tujuan || '‚Äî',
          toko: data.toko || '‚Äî',
          grandTotal: grandTotal,
          itemCount: data.items.filter(i => (parseFloat(i.banyaknya) || 0) > 0).length,
          items: data.items,
          disimpanOleh: currentUser.id,
          timestamp: now
        };
        rekapRef.child('rekap-' + now).set(rekapData);
      })
      .catch(err => alert('‚ùå Gagal: ' + err.message));
  }

  function hapusNota(container) {
    if (currentUser?.role !== 'admin') {
      alert('‚ÑπÔ∏è Hanya admin yang dapat menghapus nota.');
      return;
    }
    const id = container.dataset.notaId;
    if (!id) return;
    if (confirm('Yakin hapus nota ini?')) {
      notaRef.child(id).remove()
        .then(() => container.remove())
        .catch(err => alert('Gagal hapus: ' + err.message));
    }
  }

  function buatNotaBaru(data = null, id = null) {
    const clone = window.templateNota.cloneNode(true);
    const notaId = id || 'nota-' + Date.now();
    clone.dataset.notaId = notaId;

    if (data) {
      clone.querySelector('.nota-no').value = data.notaNo || '';
      clone.querySelector('.waktu-nota').value = data.waktu || '';
      clone.querySelector('.kepada').value = data.kepada || '';
      clone.querySelector('.tujuan').value = data.tujuan || '';
      clone.querySelector('.toko').value = data.toko || '';

      (data.items || []).forEach((item, i) => {
        const rows = clone.querySelectorAll('tbody tr');
        if (rows[i]) {
          rows[i].querySelector('.banyaknya').value = item.banyaknya || '0';
          rows[i].querySelector('.barang').value = item.barang || '';
          rows[i].querySelector('.harga').value = item.harga || '0';
        }
      });
    } else {
      clone.querySelectorAll('input').forEach(inp => {
        if (inp.type === 'text' || inp.type === 'number') inp.value = '';
        else if (inp.type === 'date') inp.value = new Date().toISOString().split('T')[0];
      });
      clone.querySelectorAll('.total').forEach(td => td.textContent = '0');
      clone.querySelector('.grand-total').textContent = '0';
    }

    hitungGrandTotal(clone);
    pasangEventListener(clone);

    const btnSimpan = clone.querySelector('.simpan-nota');
    const btnHapus = clone.querySelector('.hapus-nota');

    // Semua tombol tetap bisa diklik ‚Äî tapi hanya admin yang bisa menyimpan/hapus
    btnSimpan.onclick = () => simpanNota(clone);
    btnHapus.onclick = () => hapusNota(clone);

    document.body.appendChild(clone);
  }

  function muatSemuaNota() {
    notaRef.once('value')
      .then(snapshot => {
        const data = snapshot.val();
        if (data) {
          Object.entries(data).forEach(([id, nota]) => {
            buatNotaBaru(nota, id);
          });
        } else if (currentUser?.role === 'admin') {
          buatNotaBaru();
        }
      })
      .catch(err => {
        console.error("Error muat nota:", err);
        if (currentUser?.role === 'admin') buatNotaBaru();
      });
  }

  function tutupRekap() {
    document.getElementById('rekap-container').style.display = 'none';
  }

  function tampilkanDetailNota(rekapData) {
    const body = document.getElementById('modal-body');
    let lines = [];
    (rekapData.items || []).forEach(item => {
      const qty = parseFloat(item.banyaknya) || 0;
      if (qty > 0) {
        const barang = (item.barang || '').trim() || '‚Äî';
        const harga = parseFloat(item.harga) || 0;
        const total = qty * harga;
        lines.push(`${qty} ${barang} ${harga} ${total}`);
      }
    });
    body.textContent = lines.length ? lines.join('\n') : "Tidak ada barang.";
    document.getElementById('modal-detail').style.display = 'flex';
  }

  function tutupModal() {
    document.getElementById('modal-detail').style.display = 'none';
  }

  function tampilkanRekap() {
    if (!currentUser) return;
    document.getElementById('rekap-container').style.display = 'block';
    const daftar = document.getElementById('daftar-rekap');
    daftar.innerHTML = '<p>Memuat...</p>';
    db.ref('rekap').once('value')
      .then(snapshot => {
        const data = snapshot.val();
        if (!data) {
          daftar.innerHTML = '<p>Belum ada data rekap.</p>';
          return;
        }
        const entries = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);
        let html = `
          <table style="width:100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
              <tr>
                <th style="border:1px solid #ddd; padding:8px;">Tanggal</th>
                <th style="border:1px solid #ddd; padding:8px;">Nota No</th>
                <th style="border:1px solid #ddd; padding:8px;">Pelanggan</th>
                <th style="border:1px solid #ddd; padding:8px;">Tujuan</th>
                <th style="border:1px solid #ddd; padding:8px; text-align:right;">Total (Rp)</th>
                <th style="border:1px solid #ddd; padding:8px; text-align:center;">Item</th>
              </tr>
            </thead>
            <tbody>`;
        entries.forEach(([key, r]) => {
          html += `
            <tr>
              <td style="border:1px solid #ddd; padding:8px;">${r.waktu || '‚Äî'}</td>
              <td style="border:1px solid #ddd; padding:8px;">${r.notaNo}</td>
              <td style="border:1px solid #ddd; padding:8px;">${r.kepada}</td>
              <td style="border:1px solid #ddd; padding:8px;">${r.tujuan}</td>
              <td style="border:1px solid #ddd; padding:8px; text-align:right;">${(r.grandTotal || 0).toLocaleString('id-ID')}</td>
              <td style="border:1px solid #ddd; padding:8px; text-align:center;">
                <button class="btn" style="padding:4px 8px; font-size:12px; background:#9b59b6;" 
                        onclick='tampilkanDetailNota(${JSON.stringify(r).replace(/'/g, "\\'")})'>
                  Lihat (${r.itemCount})
                </button>
              </td>
            </tr>`;
        });
        html += `</tbody></table>`;
        daftar.innerHTML = html;
      })
      .catch(err => {
        daftar.innerHTML = '<p style="color:red;">Gagal memuat rekap: ' + err.message + '</p>';
      });
  }

  function muatCatatan() {
    notesRef.on('value', (snapshot) => {
      const text = snapshot.val() || '';
      document.getElementById('catatan-text').value = text;
      document.getElementById('catatan-status').textContent = 'Tersimpan';
    });
  }

  let catatanTimer;
  document.getElementById('catatan-text')?.addEventListener('input', () => {
    if (!currentUser) return;
    document.getElementById('catatan-status').textContent = 'Menyimpan...';
    clearTimeout(catatanTimer);
    catatanTimer = setTimeout(() => {
      notesRef.set(document.getElementById('catatan-text').value)
        .then(() => {
          document.getElementById('catatan-status').textContent = 'Tersimpan';
        });
    }, 1000);
  });
</script>
</body>
</html>